# 브라우저 렌더링 과정

## 브라우저

브라우저는 브라우저 엔진 등으로 구성   
이중에서 렌더링 엔진이 브라우저 렌더링을 담당

![](../Images/브라우저구조.png)

<br><br>

## 브라우저 렌더링 과정  
DOM트리 CSS파서 등을 기반으로 렌더트리가 구축되는 등의 작업

![](../Images/브라우저렌더링.png)

<br>

### 1. DOM 트리 구축

하나의 html 페이지는 div, span 등 각각의 요소를 가짐   
각 요소는 하나하나 `노드(Node)`로 설정이 되어 트리 형태로 저장되는데, 이것이 `DOM 트리`    

![](../Images/pic_htmltree.png)

> Ex. div > span, span이라는 요소가 있다면   
> div라는 👨‍👩‍👧‍👦부모노드 밑에 span이라는 👶🏻자식노드가 2개 생성

<br>

### 2. CSSOM 트리 구축 

각각의 노드는 `CSS 파서`에 의해 정해진 스타일 규칙이 적용되어 있음 (Ex. `span.color = "red"`)  
이런 규칙에 따라 `CSSOM 트리`가 생성  
💡DOM 트리 구축과 동시에 일어남  

![](../Images/cssparser.png)

<br>

### 3. 렌더 트리와 렌더 레이어 생성

미리 만들어놓은 `DOM 트리` 내에 있는 노드와  `CSSOM 트리`가 합쳐져 렌더객체(Render Object)가 생성    
이들이 모여 병렬적인 `렌더 트리`가 생성  
이렇게 렌더트리가 생성된 후 렌더 레이어에 올려지게 됨  

**최적화**를 거쳐 `렌더 레이어`가 완성  
* ⚠️ display:none이 포함된 노드는 지워짐   
* ⚠️ visibility: hidden 요소는 보이지 않지만 빈 공간으로 놔둠     
* 상속적인 스타일(font-size 등)은 부모노드에만 위치하도록 설계  

<br>

![](../Images/렌더트리.png)

렌더 레이어가 완성될 때 GPU에서 처리되는 부분(CSS3D / video&canvas / filter / animation / transform: translateZ(0) 등)이 있을 경우     
이 요소들은 각각 강제적으로 `그래픽 레이어(Graphic Layer)`로 분리

### 그래픽 레이어 장점 

렌더 레이어가 생성되면 레이아웃, 페인트 과정을 거침  
중간에 사용자의 화면 클릭 등 이벤트가 발생해 요소가 바뀌게 되면 레이아웃과 페인트가 다시 일어남(`리플로우(reflow)`, `리페인트(repaint)`)  
이 둘은 많이 일어나면 안됨 -> 브라우저 부하 증가  
많이 변경되는 것들은 그래픽 레이어로 분리(그렇다고 너무 많아도 안되고 대략 30개 이하 정도)   

<br>

### 4. 렌더 레이어를 대상으로 Layout 설정

이때 좌표는 보통 부모를 기준으로 설정됨  
Global Layout은 브라우저 사이즈가 증가하거나 폰트 사이즈가 커지면 변경

![](../Images/브라우저_레이아웃.png)

<br>

### 5. 렌더 레이어를 대상으로 칠하기(paint)

픽셀마다 점을 찍듯 칠하기  
레스터화라고도 함

<br>

### 6. 레이어 합치기(composite layer) 및 표기

각각의 레이어로부터 비트맵이 생성되고 GPU에 텍스처로 업로드   
그다음 텍스처들은 서로 합쳐져 하나의 이미지로 렌더링되며 `화면으로 출력`  

<br><br>

## Q. 렌더 객체와 렌더 레이어는 1:1 대응?

아니다.  
display:none으로 사라지는 노드들이 있을 수 있기 때문    
하지만 DOM 트리와 렌더 트리는 1:1대응

