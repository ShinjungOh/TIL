# Yarn 

## Yarn Plug'n'Play

Yarn 2에서 도입된 기본 설치 전략  
`node_modules` 폴더의 사용을 피하고, 패키지 관리 및 종속성 로딩을 최적화하는 방법  
프로젝트 성능 개선하고, 설치 시간 단축, 파일 시스템의 효율성 증대

### 작동 방식

Yarn에게 일반 node_modules 폴더 대신, 단일 Node.js 로더 파일을 생성하도록 지시   
`.pnp.cjs` 로더 파일에는 프로젝트의 종속성 트리에 대한 모든 정보가 포함됨  
도구에 디스크의 패키지 위치를 알리고, require 및 import 호출을 해결하는 방법을 알려줌

<br>

### 주의점

모든 도구나 라이브러리가 PnP를 완벽하게 지원하는 것은 아니므로, 프로젝트에서 사용 중인 도구의 호환성을 확인해야 함

<br><br>

## 기능 및 장점

### 1. 최소한의 설치 공간

Yarn PnP 설치는 일반적으로 한 가지 작업만 수행 -> Node.js 로더 파일(.pnp.cjs) 생성하기

다른 패키지 매니저에서는 npm같이 디스크에서 파일을 복사하거나,   
pnpm처럼 심볼릭 링크/하드 링크를 통해 파일을 복사하는 등 I/O 작업에 상당한 시간이 소요   
일반적으로 디스크 I/O 호출은 메모리의 자료구조를 다루는 것보다 훨씬 느림

<br>

### 2. 디스크 간 공유 설치

Yarn PnP는 디스크의 모든 프로젝트에서 동일한 패키지를 재사용할 수 있도록 함   
PnP 로더는 캐시 경로를 통해 패키지를 직접 참조   
-> 많은 복잡성을 제거    
-> 종속성을 검색하고 로드하는 시간을 단축시켜 성능을 개선

* pnpm : 각 패키지의 각 파일을 최종 목적지에 하드 링크해야 하는 콘텐츠 주소 지정 저장소 사용

#### 설치 과정의 효율성

node_modules 폴더에 수천 개의 파일을 복사하고 링크하는 대신, PnP는 패키지 위치를 가리키는 가상의 파일 시스템을 생성  
-> 설치 과정이 빨라지고 디스크 사용량이 크게 줄어듦  
=> ✅ **Zero Install**

<br>

### 3. 완벽하고 정확한 호이스팅

#### node_modules

일반적인 node_modules 설치는 패키지를 호이스팅해서 결과적인 node_modules 크기를 최적화하려고 함    
-> Ghost dependencies의 위험을 증가    
최적화에도 한계가 있기 때문에, 일부 종속성 패턴은 안전한 호이스팅을 방해하여 패키지 중복과 여러 인스턴스화를 초래

#### PnP

node_modules 폴더 구조를 사용하지 않고 의존성을 관리  
패키지 관리자가 의존성을 직접 관리하고 앱이 필요로 하는 모든 파일에 접근할 수 있도록 함    
PnP를 사용하면 JavaScript 엔진이 패키지를 훨씬 빠르게 해석

<br>

### 4. 유령 의존성 보호

Yarn은 모든 패키지와 그 종속성 목록을 유지하므로, 해결 중에 고려되지 않은 종속성에 대한 접근 방지   
-> 문제를 빠르게 식별하고 해결   
-> 문제가 코드베이스 깊숙이 침투하여 배포 시 애플리케이션의 안정성을 위협하기 전에 해결

package.json에 명시된 종속성만 접근하도록 제한   
-> 의도치 않은 또는 악의적인 패키지 접근을 방지

<br><br>

## 유령 의존성

명시적으로 선언되지 않은 종속성으로 인해 발생하는 예측 불가능한 문제        
Yarn PnP는 종속성 목록을 철저히 관리하고, 명시적이지 않은 접근을 차단함으로써 프로젝트의 안정성을 높임

### 유령 의존성(ghost dependencies) 개념 

프로젝트에서 직접적으로 선언되지 않았지만, **간접적으로 사용되는 종속성**  
`package.json` 파일에 명시적으로 포함되지 않은 패키지들이지만, 
다른 종속성들이 그것을 필요로 할 때 발생

<img src="/Images/유령의존성.png" alt="유령의존성">

NPM 및 Yarn v1에서는 중복해서 설치되는 node_modules를 아끼기 위해 Hoisting 기법을 사용

* 왼쪽 트리 : [A (1.0)]과 [B (1.0)] 패키지는 두 번 설치되므로 디스크 공간을 낭비
* 오른쪽 트리 : 디스크 공간을 아끼기 위해 원래 트리의 모양을 오른쪽 트리처럼 바꿈
  * -> [B (1.0)] 라이브러리를 불러올 수 있게됨  
* => 호이스팅으로 직접 의존하고 있지 않은 라이브러리를 require() 할 수 있는 현상이 유령 의존성

유령 의존성은 종종 node_modules 폴더에 포함되어 실제로는 사용 가능하지만,
**명시적으로 선언되지 않았기 때문**에 잠재적인 문제가 될 수 있음 

<br>

### 유령 의존성의 문제 

1. 예측 불가능한 오류 : 유령 종속성은 프로젝트에서 의존하고 있는 모든 패키지를 명확히 파악하기 어려움  
특정 패키지 추가/제거 시 예상치 못한 오류 발생 가능 

2. 디버깅 어려움 : 유령 종속성으로 인해 발생하는 문제는 진단/수정이 어려움
코드가 잘 작동하다가, 다른 종속성이 추가되거나 업데이트될 때 갑자기 문제가 발생할 수 있음

3. 배포 시 안정성 저하 : 유령 종속성은 개발 환경과 배포 환경 간의 불일치를 초래 가능

<br>

### PnP가 유령 의존성을 방지하는 방법

#### 1. 종속성 목록 관리 

Yarn은 프로젝트에 필요한 모든 종속성과 그 하위 종속성들을 명확하게 추적  
종속성 트리를 명확히 하고, 어떤 패키지가 어떤 다른 패키지에 의존하는지를 정확히 파악

#### 2. 명시적 접근 제한

Yarn PnP는 해결 과정에서 고려되지 않은 종속성에 대한 **접근을 차단**  
패키지가 명시적으로 선언되지 않은 종속성에 접근하려고 하면 오류를 발생시킴 

#### 3. 빠른 문제 식별

종속성이 누락된 경우, 즉시 오류 보고

<br>

### 예시

> package.json 파일에서 lodash 패키지를 명시적으로 선언하지 않았지만,   
> react 패키지가 lodash를 **간접적**으로 사용하는 경우

1. react가 업데이트되면서 더 이상 lodash를 사용하지 않게 되면, 
2. 이전에 lodash에 의존하고 있던 코드가 동작하지 않음
3. Yarn PnP는 이러한 상황에서 lodash를 명시적으로 선언하도록 강제 -> 프로젝트가 안정적으로 작동하도록 함

<br><br>

## Zero Install

Zero Install은 Yarn 2 이상에서 도입된 개념    
프로젝트를 다른 시스템으로 복사하거나 공유할 때, 별도의 패키지 설치 과정 없이 바로 사용할 수 있도록 설계된 기능

개발 환경의 초기 설정 시간을 줄이고, 프로젝트의 이식성과 일관성을 향상시킴
-> 프로젝트를 더 빠르고 효율적으로 관리하고 배포

### 장점 

#### 1. 즉시 실행 가능  
프로젝트에 필요한 모든 패키지 정보가 프로젝트와 함께 저장됨     
새 사용자나 다른 환경에서 프로젝트를 시작할 때 `yarn install`과 같은 설치 명령을 실행할 필요가 없음  
별도의 설치 과정 없이도 모든 의존성이 정확하게 해결되고 관리됨

#### 2. 의존성 포함  
프로젝트의 종속성 파일들이 `.yarn/cache` 폴더에 캐시되어 포함됨  
프로젝트를 클론할 때 모든 의존성도 함께 복사    
-> 프로젝트 버전 관리 시스템에 직접 포함될 수 있음

#### 3. 설치 속도 및 일관성 개선  
전통적인 패키지 설치 과정에서 발생할 수 있는 네트워크 지연이나 오류 없이, 프로젝트가 어디에서나 동일하게 실행될 수 있도록 보장

#### 4. PnP와의 연관성  
PnP를 사용하면, Yarn은 물리적인 `node_modules` 폴더 대신 **가상의 파일 매핑**을 생성하여 모든 패키지를 관리  
=> ✅ Zero Install 전략을 가능하게 하는 핵심 요소 중 하나

<br><br>

## 참고 사이트

> https://yarnpkg.com/features/pnp  
> https://toss.tech/article/node-modules-and-yarn-berry
